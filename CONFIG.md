# 配置说明 (Configuration Guide)

本文档详细说明 HAADF-STEM 解卷积工具的各项参数配置。

## 目录

- [显微镜参数](#显微镜参数)
- [解卷积参数](#解卷积参数)
- [高级像差参数](#高级像差参数)
- [后处理参数](#后处理参数)
- [显示参数](#显示参数)
- [参数推荐值](#参数推荐值)

## 显微镜参数

### Voltage (电压)

**单位**: kV (千伏)

**说明**: 电子显微镜的加速电压。

**常见值**:
- 80 kV: 适用于低电压 TEM
- 200 kV: 常规 TEM 标准
- 300 kV: 高分辨率 TEM（最常用）
- 1000 kV: 超高压 TEM

**影响**: 电压越高，电子波长越短，分辨率越高，但样品损伤可能增加。

### Cs3 (三级球差)

**单位**: mm (毫米)

**说明**: 球差系数的三级分量，是主要的像差之一。

**典型值**:
- 球差校正器未启用: 0.5 - 3.0 mm
- 球差校正器启用: < 0.1 mm
- 现代 TEM: 通常 < 1.0 mm

**影响**: Cs 越大，分辨率越低。球差校正可以显著改善分辨率。

### Cs5 (五级球差)

**单位**: mm (毫米)

**说明**: 球差系数的五级分量，通常比 Cs3 小得多。

**典型值**: 0.0 - 0.5 mm

**影响**: 主要影响高角度散射，对大多数图像可以设为 0。

### Defocus (离焦量)

**单位**: nm (纳米)

**说明**: 物镜的离焦距离，正值表示过焦，负值表示欠焦。

**典型值**:
- 欠焦: -10 ~ -100 nm（最常用）
- 过焦: +10 ~ +100 nm
- 薛氏调焦: 略正的值（用于相位衬度）

**影响**:
- 欠焦时，衬度增强，但可能有假频
- 过焦时，图像模糊
- 离焦过大会导致 CTF 振荡

**设置建议**: 使用图像的傅里叶变换观察 CTF，选择 CTF 第一个零点位置合适的离焦量。

### Objective Aperture (物镜光阑)

**单位**: mrad (毫弧度)

**说明**: 物镜光阑的收集角度，决定了探针的半角。

**典型值**:
- 8 - 12 mrad: 低角度，高穿透
- 12 - 20 mrad: 标准设置（常用）
- 20 - 30 mrad: 高角度，高分辨率

**影响**:
- 角度越大，探针越小，分辨率越高
- 但高角度会导致探针拖尾，增加计算复杂度

### Pixel Size (像素尺寸)

**单位**: nm (纳米)

**说明**: 图像像素对应的实际物理尺寸，通常从 MRC 文件元数据自动读取。

**计算方法**:
```
Pixel Size = Camera Pixel Size × Magnification / 1000
```

**影响**: 像素尺寸越小，数字分辨率越高，但数据量也越大。

## 解卷积参数

### Iterations (迭代次数)

**范围**: 1 - 100

**说明**: 解卷积算法的迭代次数。

**推荐值**:
- 快速预览: 5 - 10 次
- 标准处理: 15 - 30 次
- 高质量: 30 - 50 次
- 不建议超过 100 次

**影响**:
- 迭代太少: 解卷积不充分，模糊
- 迭代太多: 噪声放大，可能出现伪影

**选择建议**:
1. 从 10 次开始
2. 观察结果
3. 逐步增加，找到最佳平衡点

### Lambda (RL 正则化参数)

**范围**: 0.0001 - 1.0

**说明**: Richardson-Lucy 算法的正则化参数，控制图像平滑程度。

**推荐值**:
- 0.001 - 0.01: 锐利图像，可能有噪声
- 0.01 - 0.05: 平衡设置（常用）
- 0.05 - 0.1: 平滑图像，噪声少

**影响**:
- λ 小: 图像锐利，但噪声放大
- λ 大: 图像平滑，但细节丢失

**选择建议**:
- 高信噪比图像: λ = 0.001 - 0.01
- 低信噪比图像: λ = 0.01 - 0.1
- 可以通过尝试不同值找到最佳值

### Lambda (FISTA 正则化参数)

**范围**: 0.0001 - 1.0

**说明**: FISTA 算法的 L1 正则化参数。

**推荐值**: 0.005 - 0.05

**影响**: 类似 RL 的 λ，但 FISTA 使用 L1 正则化，更适合稀疏数据。

### Regularization Type (正则化类型)

**选项**:
- **TV (Total Variation)**: 全变分正则化
  - 优点: 保持边缘清晰
  - 缺点: 可能产生块状伪影
  - 适用: 边缘清晰的图像
- **L2 (L2 范数)**: 平滑正则化
  - 优点: 平滑自然
  - 缺点: 可能模糊边缘
  - 适用: 噪声较多的图像

**选择建议**:
- 默认使用 TV，如果出现块状伪影则尝试 L2。

### Boundary Handling (边界处理)

**选项**: True / False

**说明**: 是否处理图像边界以减少伪影。

**推荐**: **True** (始终开启)

**影响**:
- True: 边界伪影减少，计算量略增
- False: 边界可能有环形伪影，计算更快

## 高级像差参数

这些参数通常用于高分辨率成像，一般图像可以设为 0。

### A2 Aberration (二级像差)

**Amplitude**: nm
**Angle**: rad (弧度)

说明: 二级像差，包括像散等。

### A3 Aberration (三级像差)

**Amplitude**: nm
**Angle**: rad (弧度)

说明: 三级像差，包括彗差等。

### B2 Aberration

**Amplitude**: nm
**Angle**: rad (弧度)

说明: 特定的像差分量。

### Focal Spread (焦散)

**单位**: nm

**说明**: 焦点的统计分布宽度，用于部分相干性建模。

**典型值**: 2 - 10 nm

### Convergence Angle (收敛角)

**单位**: rad (弧度)

**说明**: 电子束的收敛角。

**典型值**: 0.005 - 0.02 rad

## 后处理参数

### Apply Wiener Filter (应用维纳滤波)

**选项**: True / False

**说明**: 应用维纳滤波抑制高频噪声。

**推荐**: **True** (推荐开启)

**影响**:
- True: 噪声减少，信噪比提高
- False: 保持原始解卷积结果

### Use P-spline Filter (使用 P-样条滤波)

**选项**: True / False

**说明**: 使用 P-样条滤波替代传统径向维纳滤波。

**推荐**: False (除非需要特殊频率响应)

**区别**:
- 径向维纳: 径向对称，简单快速
- P-样条: 可以控制不同方向的频率响应，更灵活

### P-spline Lambda (P-样条平滑参数)

**范围**: 1 - 10000

**说明**: P-样条滤波的平滑强度。

**推荐值**: 100 - 1000

**影响**:
- 小值: 平滑较弱
- 大值: 平滑较强

### Information Limit (信息截止频率)

**单位**: 1/nm 或 1/Å (空间频率)

**说明**: 显微镜的信息极限频率，高于此频率的信息被滤除。

**选项**: "Auto" 或 具体数值

**推荐**: **Auto** (自动估计)

**自动估计**: 基于探针的振幅谱自动确定截止频率。

## 显示参数

### Space (空间域)

**选项**:
- **Real Space**: 实空间图像
- **Frequency Space**: 傅里叶空间（频域）

**说明**: 切换图像显示的空间域。

**用途**:
- 实空间: 观察图像结构和细节
- 频域: 观察 CTF、探针形状、频率成分

### Mode (显示模式)

**选项**:
- **Linear**: 线性显示（原始数据）
- **Power**: 功率谱（振幅的平方）
- **Log**: 对数显示（动态范围压缩）

**说明**: 控制图像的显示方式。

**用途**:
- Linear: 适合实空间图像
- Power: 适合频域分析
- Log: 适合同时显示高低频信息

### Colormap (色彩映射)

**选项**: gray, viridis, plasma, inferno, magma, jet, hot, cool

**说明**: 选择图像的颜色映射方案。

**推荐**:
- gray: 科学分析（黑白，客观）
- viridis: 感知均匀，适合所有人
- plasma/inferno/magma: 颜色丰富，适合展示
- jet: 传统的温度图（不推荐用于分析）

## 参数推荐值

### 300 kV 显微镜（常用设置）

```
Voltage:      300 kV
Cs3:          0.5 mm
Cs5:          0.0 mm
Defocus:     -44 nm
Obj. Aperture: 16 mrad
Pixel Size:   0.05 - 0.2 nm

Iterations:     15 - 25
Lambda (RL):    0.002 - 0.005
Reg. Type:      TV
Boundary:       True

Wiener:         True
P-spline:       False
Info Limit:     Auto
```

### 200 kV 显微镜

```
Voltage:      200 kV
Cs3:          1.0 mm
Cs5:          0.0 mm
Defocus:     -50 nm
Obj. Aperture: 15 mrad
Pixel Size:   0.05 - 0.2 nm

Iterations:     20 - 30
Lambda (RL):    0.003 - 0.008
Reg. Type:      TV
Boundary:       True
```

### 低信噪比图像

```
Iterations:     10 - 15 (避免噪声放大)
Lambda (RL):    0.01 - 0.05 (强正则化)
Reg. Type:      L2 (更平滑)
Wiener:         True (后处理降噪)
```

### 高信噪比图像

```
Iterations:     25 - 40 (充分利用数据)
Lambda (RL):    0.001 - 0.005 (弱正则化)
Reg. Type:      TV (保持边缘)
Wiener:         False (保持细节)
```

## 参数调优策略

### 步骤 1: 确定 CTF 参数

1. 在频域查看原始图像
2. 观察 CTF 振荡
3. 调整 Defocus，使第一个零点位置合理

### 步骤 2: 设置基本解卷积参数

1. Iterations = 15
2. Lambda = 0.002
3. Reg. Type = TV
4. Boundary = True

### 步骤 3: 迭代优化

1. 查看解卷积结果
2. 如果模糊: 增加迭代次数
3. 如果噪声多: 减小迭代次数或增大 λ

### 步骤 4: 细节调整

1. 如果边缘伪影: 切换到 L2 正则化
2. 如果块状伪影: 切换到 L2 或增大 λ
3. 如果高频噪声: 开启维纳滤波

## 故障排除

### 问题: 结果仍然模糊

**可能原因**:
- 迭代次数太少
- λ 太大
- CTF 参数不正确

**解决**:
- 增加迭代次数到 30-50
- 减小 λ 到 0.001-0.002
- 检查 Voltage, Cs3, Defocus 是否正确

### 问题: 噪声明显

**可能原因**:
- 迭代次数太多
- λ 太小
- 输入图像噪声多

**解决**:
- 减小迭代次数到 10-15
- 增大 λ 到 0.01-0.05
- 启用维纳滤波后处理
- 使用 L2 正则化

### 问题: 出现环形伪影

**可能原因**:
- CTF 参数错误
- 未启用边界处理

**解决**:
- 检查并修正 Defocus 值
- 确保 Boundary Handling = True

### 问题: 边缘有块状纹理

**可能原因**:
- TV 正则化过于强烈

**解决**:
- 切换到 L2 正则化
- 或减小 TV 的 λ

### 问题: 频域图像异常

**可能原因**:
- Pixel Size 不正确

**解决**:
- 检查 MRC 文件元数据
- 手动设置正确的 Pixel Size

## 参考资料

- HAADF-STEM 成像原理
- 解卷积算法原理
- 显微镜参数手册

如有更多问题，请参考 [README.md](README.md) 或提交 [Issue](https://github.com/chenguisen/dec_stem_for_computer/issues)。
